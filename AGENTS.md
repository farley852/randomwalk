# AGENTS.md

このリポジトリで Codex が作業するための共通ルールです。

## 出力と言語

- 最終的な説明・報告は **日本語**。
- コード内コメント・変数名・コミットメッセージは **英語**。

## 基本姿勢

- 既存の設計・規約・ファイル構成を尊重し、差分は最小にする。
- 不確実な点は隠さず、事実（ログ/テスト結果/コード根拠）に基づいて進める。
- 大きい変更は、編集前に「何を・なぜ・どこを・影響は何か・どう検証するか」を短く提示する。

## AGENTSの運用

- このファイルは「契約」。ルールの削除/大きな変更は、理由と代替案を提示してから行う。
- 末尾の「プロジェクト固有知見」は、開発中に得た恒久的な学びのみ追記してよい。

## セッション開始時の確認

- `CLAUDE.md`（プロジェクト概要・アーキテクチャ）
- `README.md`（あれば）
- 直近の git log（最近の変更状況の把握）

## セットアップ / ビルド

| 操作       | コマンド                            |
| ---------- | ----------------------------------- |
| Install    | `npm install`                       |
| Dev        | `npm run dev`                       |
| Build      | `npm run build`（tsc + vite build） |
| Type check | `npx tsc --noEmit`                  |

- テストフレームワーク: Vitest (`npm test`)
- Lint / Format: ESLint + Prettier (`npm run lint` / `npm run format:check`)

## 承認が必要な操作

以下は実行前に必ず承認を求める：

- 新しい本番依存関係の追加（`dependencies`への追加）
- 破壊的操作（`rm -rf`、`git push --force`、大規模自動書換え）
- アーキテクチャ変更（ファイル構成・データフロー・レンダリングパイプラインの変更）

## 知見の記録ルール

| 情報の種類                                   | 記録先                            | 更新方法   |
| -------------------------------------------- | --------------------------------- | ---------- |
| 恒久的教訓（ハマりポイント、設計判断の理由） | AGENTS.md「プロジェクト固有知見」 | 追記       |
| セッション跨ぎの作業状態                     | `.codex/status.md`                | 上書き更新 |

## 開発規律

### コード品質・設計

- 重複を避け、単一の信頼できる情報源（SSOT）を作る。
- コメントは「なぜ」を中心に、仕様・制約・トレードオフを残す。
- 既存のコーディングスタイルを最優先で踏襲する。

### 保守性

- 大規模変更は小さなステップに分割し、常に動く状態を保つ。
- 未使用コードは削除する。

### パフォーマンス

- 推測で最適化しない。計測→ボトルネック特定→最小変更で改善。
- Canvas描画は60fps維持を前提にする（5000ステップ + ヒートマップON）。

### Git運用

- Conventional Commits を使用（`feat:`, `fix:`, `docs:`, `refactor:`, `chore:`）。
- コミットは原子的に（1コミット=1意図）。型チェックが通る状態で区切る。

### 依存関係

- 本当に必要な依存だけ追加。追加前にライセンス・サイズ・メンテ状況を確認。

### ドキュメント

- 振る舞いが変わったら、同時に CLAUDE.md のアーキテクチャ図を更新する。

## Claude Code 併用メモ

- `CLAUDE.md` はプロジェクト概要・アーキテクチャを、`AGENTS.md` は運用ルールを担う。
- 両者の情報が矛盾しないよう、変更時は両方を確認する。
- `.claude/agents/codex-worker.md` で Codex MCP 連携を定義済み。

## プロジェクト固有知見

- ヒートマップのグリッド次元は全ポイントのバウンディングボックスから計算する（カメラと同じ）。これによりインクリメンタル更新時にグリッドの再確保が不要になる。
- DDAラスタライズのループは `cols + rows + 2` で安全制限をかける（無限ループ防止）。
- `OffscreenCanvas` + `drawImage` でヒートマップを拡大描画すると、ピクセル単位の `fillRect` より大幅に高速。
- Trail Fade のループ開始を `max(0, upToStep - trailLength)` にすることで O(trailLength) に最適化。
